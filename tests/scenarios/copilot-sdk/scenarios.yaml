# Test scenarios for copilot-sdk skill evaluation
# Each scenario tests Copilot SDK integration patterns

config:
  model: gpt-4
  max_tokens: 2000
  temperature: 0.3

scenarios:
  # Basic Client and Session
  - name: basic_client_session
    prompt: |
      Create a basic Copilot SDK application in TypeScript that creates
      a client, opens a session with gpt-4.1, sends a prompt, prints
      the response, and properly shuts down.
    expected_patterns:
      - "import.*CopilotClient"
      - "new CopilotClient"
      - "createSession"
      - "sendAndWait"
      - "response.*content"
      - "stop\\(\\)"
    forbidden_patterns:
      - "api_key.*=.*[\"']sk-"
      - "hardcoded"
    tags:
      - typescript
      - basic
    mock_response: |
      import { CopilotClient } from "@github/copilot-sdk";

      const client = new CopilotClient();
      const session = await client.createSession({ model: "gpt-4.1" });

      const response = await session.sendAndWait({ prompt: "Explain async/await in JavaScript" });
      console.log(response?.data.content);

      await client.stop();

  # Python Client
  - name: python_client_session
    prompt: |
      Create a basic Copilot SDK application in Python that creates
      a client, opens a session, sends a prompt, and shuts down.
      Use async/await pattern.
    expected_patterns:
      - "from copilot import CopilotClient"
      - "await.*start"
      - "create_session"
      - "send_and_wait"
      - "await.*stop"
      - "asyncio"
    forbidden_patterns:
      - "import copilot_sdk"
    tags:
      - python
      - basic
    mock_response: |
      import asyncio
      from copilot import CopilotClient

      async def main():
          client = CopilotClient()
          await client.start()

          session = await client.create_session({"model": "gpt-4.1"})
          response = await session.send_and_wait({"prompt": "Explain async/await in Python"})
          print(response.data.content)

          await client.stop()

      asyncio.run(main())

  # Streaming Responses
  - name: streaming_responses
    prompt: |
      Create a Copilot SDK application in TypeScript that uses streaming
      to print response tokens in real-time. Subscribe to delta events
      and detect when the session becomes idle.
    expected_patterns:
      - "streaming.*true"
      - "on\\("
      - "assistant.message_delta|message_delta"
      - "deltaContent|delta_content"
      - "session.idle|idle"
      - "sendAndWait"
    forbidden_patterns:
      - "sendAndWait.*\\{\\s*\\}"
    tags:
      - typescript
      - streaming
    mock_response: |
      import { CopilotClient } from "@github/copilot-sdk";

      const client = new CopilotClient();
      const session = await client.createSession({
        model: "gpt-4.1",
        streaming: true,
      });

      session.on("assistant.message_delta", (event) => {
        process.stdout.write(event.data.deltaContent);
      });

      session.on("session.idle", () => {
        console.log("\n--- Stream complete ---");
      });

      await session.sendAndWait({ prompt: "Write a haiku about programming" });
      await client.stop();

  # Custom Tool Definition
  - name: custom_tool_typescript
    prompt: |
      Create a custom tool using the Copilot SDK in TypeScript that
      looks up a user by ID. Use defineTool with proper JSON Schema
      parameters and an async handler.
    expected_patterns:
      - "defineTool"
      - "description"
      - "parameters"
      - "type.*object"
      - "properties"
      - "handler"
      - "tools.*\\["
    forbidden_patterns:
      - "any"
    tags:
      - typescript
      - tools
    mock_response: |
      import { CopilotClient, defineTool } from "@github/copilot-sdk";

      const lookupUser = defineTool("lookup_user", {
        description: "Look up a user by their ID",
        parameters: {
          type: "object",
          properties: {
            userId: { type: "string", description: "The user's unique identifier" },
          },
          required: ["userId"],
        },
        handler: async ({ userId }) => {
          const users: Record<string, { name: string; email: string }> = {
            "u1": { name: "Alice", email: "alice@example.com" },
            "u2": { name: "Bob", email: "bob@example.com" },
          };
          const user = users[userId];
          if (!user) return { error: "User not found" };
          return { userId, ...user };
        },
      });

      const client = new CopilotClient();
      const session = await client.createSession({
        model: "gpt-4.1",
        tools: [lookupUser],
      });

      await session.sendAndWait({ prompt: "Look up user u1" });
      await client.stop();

  # Python Tool with Pydantic
  - name: custom_tool_python
    prompt: |
      Create a custom tool using the Copilot SDK in Python that
      calculates the area of a shape. Use Pydantic for parameter
      validation with the @define_tool decorator.
    expected_patterns:
      - "from copilot.tools import define_tool"
      - "from pydantic import BaseModel"
      - "@define_tool"
      - "class.*Params.*BaseModel"
      - "Field"
      - "async def"
    forbidden_patterns:
      - "def.*\\*\\*kwargs"
    tags:
      - python
      - tools
      - pydantic
    mock_response: |
      from copilot import CopilotClient
      from copilot.tools import define_tool
      from pydantic import BaseModel, Field
      import math

      class AreaParams(BaseModel):
          shape: str = Field(description="Shape type: circle, rectangle, or triangle")
          width: float = Field(description="Width (or radius for circle)")
          height: float = Field(default=0, description="Height (not used for circle)")

      @define_tool(description="Calculate the area of a geometric shape")
      async def calculate_area(params: AreaParams) -> dict:
          if params.shape == "circle":
              area = math.pi * params.width ** 2
          elif params.shape == "rectangle":
              area = params.width * params.height
          elif params.shape == "triangle":
              area = 0.5 * params.width * params.height
          else:
              return {"error": f"Unknown shape: {params.shape}"}
          return {"shape": params.shape, "area": round(area, 2)}

      async def main():
          client = CopilotClient()
          await client.start()
          session = await client.create_session({
              "model": "gpt-4.1",
              "tools": [calculate_area],
          })
          await session.send_and_wait({"prompt": "What is the area of a circle with radius 5?"})
          await client.stop()

  # Hooks - Pre Tool Use
  - name: hooks_pre_tool_use
    prompt: |
      Create a Copilot SDK session in TypeScript with a pre-tool-use hook
      that denies shell/bash commands and allows all other tools. Return
      the permission decision with a reason.
    expected_patterns:
      - "hooks"
      - "onPreToolUse"
      - "permissionDecision"
      - "deny|allow"
      - "permissionDecisionReason"
      - "toolName|tool_name"
      - "shell|bash"
    tags:
      - typescript
      - hooks
      - security
    mock_response: |
      import { CopilotClient } from "@github/copilot-sdk";

      const client = new CopilotClient();
      const session = await client.createSession({
        model: "gpt-4.1",
        hooks: {
          onPreToolUse: async (input) => {
            if (["shell", "bash"].includes(input.toolName)) {
              return {
                permissionDecision: "deny",
                permissionDecisionReason: "Shell access is not permitted in this environment",
              };
            }
            return { permissionDecision: "allow" };
          },
        },
      });

      await session.sendAndWait({ prompt: "List files in the current directory" });
      await client.stop();

  # MCP Server Integration
  - name: mcp_server_integration
    prompt: |
      Create a Copilot SDK session in TypeScript that connects to both
      a remote HTTP MCP server (GitHub) and a local stdio MCP server
      (filesystem). Configure tools for each.
    expected_patterns:
      - "mcpServers"
      - "type.*http"
      - "type.*local"
      - "url"
      - "command"
      - "args"
      - "tools.*\\[.*\\*.*\\]"
    tags:
      - typescript
      - mcp
    mock_response: |
      import { CopilotClient } from "@github/copilot-sdk";

      const client = new CopilotClient();
      const session = await client.createSession({
        model: "gpt-4.1",
        mcpServers: {
          github: {
            type: "http",
            url: "https://api.githubcopilot.com/mcp/",
            tools: ["*"],
          },
          filesystem: {
            type: "local",
            command: "npx",
            args: ["-y", "@modelcontextprotocol/server-filesystem", "/workspace"],
            tools: ["*"],
          },
        },
      });

      await session.sendAndWait({ prompt: "List files in /workspace" });
      await client.stop();

  # BYOK Provider
  - name: byok_provider
    prompt: |
      Create a Copilot SDK session using BYOK (Bring Your Own Key) with
      an Azure OpenAI endpoint. Use the Responses wire API for GPT-5
      series models. Read the API key from an environment variable.
    expected_patterns:
      - "provider"
      - "type.*openai|type.*azure"
      - "baseUrl|base_url"
      - "wireApi.*responses|wire_api.*responses"
      - "apiKey|api_key"
      - "process.env|os.environ"
    forbidden_patterns:
      - "apiKey.*[\"'][a-zA-Z0-9]{20}"
    tags:
      - typescript
      - byok
      - azure
    mock_response: |
      import { CopilotClient } from "@github/copilot-sdk";

      const client = new CopilotClient();
      const session = await client.createSession({
        model: "gpt-5.2-codex",
        provider: {
          type: "openai",
          baseUrl: "https://my-resource.openai.azure.com/openai/v1/",
          wireApi: "responses",
          apiKey: process.env.AZURE_OPENAI_API_KEY,
        },
      });

      const response = await session.sendAndWait({ prompt: "Hello from BYOK!" });
      console.log(response?.data.content);

      await client.stop();

  # Session Persistence
  - name: session_persistence
    prompt: |
      Create a Copilot SDK application in TypeScript that creates a
      resumable session with a custom ID, sends a message, then later
      resumes that session and continues the conversation.
    expected_patterns:
      - "sessionId"
      - "createSession"
      - "resumeSession"
      - "sendAndWait"
    tags:
      - typescript
      - persistence
    mock_response: |
      import { CopilotClient } from "@github/copilot-sdk";

      const client = new CopilotClient();

      // Create a resumable session with custom ID
      const session = await client.createSession({
        sessionId: "project-alpha-task-1",
        model: "gpt-4.1",
      });

      await session.sendAndWait({ prompt: "Remember: the project deadline is March 15th" });
      console.log("Session created and context saved.");

      // Later: resume the session
      const resumed = await client.resumeSession("project-alpha-task-1");
      const response = await resumed.sendAndWait({ prompt: "When is the deadline?" });
      console.log(response?.data.content);

      await client.stop();

  # Go Client
  - name: go_client_session
    prompt: |
      Create a basic Copilot SDK application in Go that creates a client,
      opens a session, sends a prompt, and shuts down. Use proper error
      handling and defer for cleanup.
    expected_patterns:
      - "copilot.NewClient"
      - "CreateSession"
      - "SendAndWait"
      - "defer.*Stop"
      - "SessionConfig"
      - "MessageOptions|Prompt"
    forbidden_patterns:
      - "panic\\("
    tags:
      - go
      - basic
    mock_response: |
      package main

      import (
        "context"
        "fmt"
        "log"
        copilot "github.com/github/copilot-sdk/go"
      )

      func main() {
        ctx := context.Background()
        client := copilot.NewClient(nil)

        if err := client.Start(ctx); err != nil {
          log.Fatal(err)
        }
        defer client.Stop()

        session, err := client.CreateSession(ctx, &copilot.SessionConfig{
          Model: "gpt-4.1",
        })
        if err != nil {
          log.Fatal(err)
        }

        response, err := session.SendAndWait(ctx, copilot.MessageOptions{
          Prompt: "Explain goroutines in Go",
        })
        if err != nil {
          log.Fatal(err)
        }

        if response != nil && response.Data.Content != nil {
          fmt.Println(*response.Data.Content)
        }
      }

  # Custom Agent Definition
  - name: custom_agent_definition
    prompt: |
      Create a Copilot SDK session in TypeScript that defines a custom
      agent persona for code review. Include a name, description, and
      system prompt for the agent.
    expected_patterns:
      - "customAgents"
      - "name"
      - "description"
      - "prompt"
      - "createSession"
    tags:
      - typescript
      - agents
    mock_response: |
      import { CopilotClient } from "@github/copilot-sdk";

      const client = new CopilotClient();
      const session = await client.createSession({
        model: "gpt-4.1",
        customAgents: [
          {
            name: "code-reviewer",
            displayName: "Code Reviewer",
            description: "Reviews code for bugs, security issues, and best practices",
            prompt: `You are an expert code reviewer. Focus on:
      - Security vulnerabilities (injection, auth issues)
      - Performance problems (N+1 queries, memory leaks)
      - Code maintainability (naming, complexity, DRY)
      Be concise. Only flag real issues, not style preferences.`,
          },
        ],
      });

      await session.sendAndWait({
        prompt: "Review this function: function add(a, b) { return a + b; }",
      });
      await client.stop();

  # Multi-Tool Session
  - name: multi_tool_session
    prompt: |
      Create a Copilot SDK application in TypeScript that registers
      multiple custom tools (a file reader and a calculator) and uses
      them together in a single session.
    expected_patterns:
      - "defineTool"
      - "tools.*\\["
      - "handler"
      - "createSession"
      - "parameters"
    forbidden_patterns:
      - "any"
      - "api_key.*=.*[\"']sk-"
    tags:
      - typescript
      - tools
      - multi-tool
    mock_response: |
      import { CopilotClient, defineTool } from "@github/copilot-sdk";

      const readFile = defineTool("read_file", {
        description: "Read the contents of a file",
        parameters: {
          type: "object",
          properties: {
            path: { type: "string", description: "File path to read" },
          },
          required: ["path"],
        },
        handler: async ({ path }) => {
          const fs = await import("fs/promises");
          const content = await fs.readFile(path, "utf-8");
          return { content };
        },
      });

      const calculate = defineTool("calculate", {
        description: "Evaluate a math expression",
        parameters: {
          type: "object",
          properties: {
            expression: { type: "string", description: "Math expression" },
          },
          required: ["expression"],
        },
        handler: async ({ expression }) => {
          const result = Function(`"use strict"; return (${expression})`)();
          return { result };
        },
      });

      const client = new CopilotClient();
      const session = await client.createSession({
        model: "gpt-4.1",
        tools: [readFile, calculate],
      });

      await session.sendAndWait({
        prompt: "Read package.json and count how many dependencies there are",
      });
      await client.stop();

  # Error Handling Pattern
  - name: error_handling_typescript
    prompt: |
      Create a Copilot SDK application in TypeScript with proper error
      handling. Wrap client operations in try/catch/finally blocks and
      ensure the client is always stopped even on errors.
    expected_patterns:
      - "try"
      - "catch"
      - "finally"
      - "stop\\(\\)"
      - "CopilotClient"
      - "createSession"
    forbidden_patterns:
      - "api_key.*=.*[\"']sk-"
    tags:
      - typescript
      - error-handling
    mock_response: |
      import { CopilotClient } from "@github/copilot-sdk";

      const client = new CopilotClient();

      try {
        const session = await client.createSession({ model: "gpt-4.1" });
        const response = await session.sendAndWait({
          prompt: "Explain error handling best practices",
        });

        if (response?.data.content) {
          console.log(response.data.content);
        } else {
          console.error("No response received");
        }
      } catch (error) {
        console.error("Copilot SDK error:", error);
        process.exitCode = 1;
      } finally {
        await client.stop();
      }

  # Streaming with Tools
  - name: streaming_with_tools
    prompt: |
      Create a Copilot SDK application in TypeScript that combines
      streaming responses with a custom tool. Enable streaming and
      listen for both delta events and tool call events.
    expected_patterns:
      - "streaming.*true"
      - "defineTool"
      - "tools.*\\["
      - "on\\("
      - "deltaContent|delta_content"
      - "sendAndWait"
    forbidden_patterns:
      - "any"
    tags:
      - typescript
      - streaming
      - tools
    mock_response: |
      import { CopilotClient, defineTool } from "@github/copilot-sdk";

      const getWeather = defineTool("get_weather", {
        description: "Get the current weather for a city",
        parameters: {
          type: "object",
          properties: {
            city: { type: "string", description: "City name" },
          },
          required: ["city"],
        },
        handler: async ({ city }) => {
          return { city, temperature: 72, condition: "sunny" };
        },
      });

      const client = new CopilotClient();
      const session = await client.createSession({
        model: "gpt-4.1",
        streaming: true,
        tools: [getWeather],
      });

      session.on("assistant.message_delta", (event) => {
        process.stdout.write(event.data.deltaContent);
      });

      session.on("session.idle", () => {
        console.log("\n--- Done ---");
      });

      await session.sendAndWait({
        prompt: "What's the weather in San Francisco?",
      });
      await client.stop();

  # Python Streaming
  - name: python_streaming
    prompt: |
      Create a Copilot SDK application in Python that uses streaming
      to print response tokens as they arrive. Use async event handlers
      and proper cleanup.
    expected_patterns:
      - "from copilot import CopilotClient"
      - "await.*start"
      - "create_session"
      - "streaming"
      - "on.*delta|on_event"
      - "await.*stop"
      - "asyncio"
    forbidden_patterns:
      - "import copilot_sdk"
    tags:
      - python
      - streaming
    mock_response: |
      import asyncio
      from copilot import CopilotClient

      async def main():
          client = CopilotClient()
          await client.start()

          session = await client.create_session({
              "model": "gpt-4.1",
              "streaming": True,
          })

          def on_delta(event):
              print(event.data.delta_content, end="", flush=True)

          def on_idle(event):
              print("\n--- Stream complete ---")

          session.on("assistant.message_delta", on_delta)
          session.on("session.idle", on_idle)

          await session.send_and_wait({"prompt": "Write a haiku about Python"})
          await client.stop()

      asyncio.run(main())

  # MCP with Tool Filtering
  - name: mcp_tool_filtering
    prompt: |
      Create a Copilot SDK session in TypeScript that connects to an
      MCP server but only allows specific tools instead of all tools.
      Show how to filter which MCP tools are available.
    expected_patterns:
      - "mcpServers"
      - "tools.*\\["
      - "type.*local|type.*http"
      - "createSession"
    forbidden_patterns:
      - "api_key.*=.*[\"']sk-"
    tags:
      - typescript
      - mcp
      - security
    mock_response: |
      import { CopilotClient } from "@github/copilot-sdk";

      const client = new CopilotClient();
      const session = await client.createSession({
        model: "gpt-4.1",
        mcpServers: {
          filesystem: {
            type: "local",
            command: "npx",
            args: ["-y", "@modelcontextprotocol/server-filesystem", "/workspace"],
            tools: ["read_file", "list_directory"],
          },
          github: {
            type: "http",
            url: "https://api.githubcopilot.com/mcp/",
            tools: ["search_repositories", "get_file_contents"],
          },
        },
      });

      await session.sendAndWait({ prompt: "List files in the workspace" });
      await client.stop();
